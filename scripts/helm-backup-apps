AWS_ACCESS_KEY=$(sed -n 's/aws_access_key_id[ =]*//p' /root/.aws/credentials 2>/dev/null)
AWS_SECRET_KEY=$(sed -n 's/aws_secret_access_key[ =]*//p' /root/.aws/credentials 2>/dev/null)
ADMIN_PW=$(kubectl get secret pxcentral-keycloak-http -n central -o jsonpath="{.data.password}" | base64 --decode)

if [ "$platform" = ocp4 ]; then

# create ocp route for backup UI
cat <<EOF | kubectl apply -f -
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  name: px-backup-ui
  namespace: central
spec:
  to:
    kind: Service
    name: px-backup-ui
    weight: 100
  port:
    targetPort: http
  wildcardPolicy: None
EOF

# create ocp route for central UI
cat <<EOF | kubectl apply -f -
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  name: px-central-ui
  namespace: central
spec:
  to:
    kind: Service
    name: px-central-ui
    weight: 100
  port:
    targetPort: http
  wildcardPolicy: None
EOF

  # expose px-backup service to run pxbackupctl
  kubectl patch svc px-backup -n central -p '{"spec":{"type":"LoadBalancer"}}'
  backupIP=$(kubectl get svc px-backup -n central -o json | jq -r ".status.loadBalancer.ingress[0].hostname")
 
  while [ $backupIP = "null" ]; do
    sleep 2
    echo "PX Backup grpc LB not assigned"
    backupIP=$(kubectl get svc px-backup -n central -o json | jq -r ".status.loadBalancer.ingress[0].hostname")
  done
  echo "PX Backup grpc LB assigned: $backupIP"
  
  backupPort=10002
  authIP=$(kubectl get route px-central-ui -n central -o json |jq -r ".status.ingress[0].host")
  authPort=80
  PXB_URL=$(kubectl get route px-backup-ui -n central -o json |jq -r ".status.ingress[0].host")

else  # platform is k8s on aws

  IMDSTOKEN=$(curl -s -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds: 120')
  backupIP=$(curl -H "X-aws-ec2-metadata-token: $IMDSTOKEN" -s http://169.254.169.254/latest/meta-data/public-ipv4)
  authIP=$backupIP
  authPort=$(kubectl get svc px-central-ui -n central -o=jsonpath='{.spec.ports[?(@.port==80)].nodePort}')

#expose px-backup api grpc endpoint
kubectl apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: px-backup-api-grpc
  namespace: central
spec:
  ports:
  - name: grpc
    port: 10002
    protocol: TCP
    targetPort: 10002
  selector:
    app: px-backup
  type: NodePort
EOF
  backupPort=$(kubectl get svc px-backup-api-grpc -n central -o=jsonpath='{.spec.ports[?(@.port==10002)].nodePort}')
  PXB_URL=$(kubectl get svc px-backup-ui -n central -o=jsonpath='{.status.loadBalancer.ingress[0].hostname}')
fi

px pxb init config  --px-backup-api-url http://$backupIP:$backupPort --pxcentral-auth-url http://$authIP:$authPort
px pxb set config --pxcentral-verify-ssl false
px pxb login --username admin --password $ADMIN_PW

while ! px pxb version; do
        echo "waiting for grpc availability"
        sleep 2
done

px pxb create cloudcredential --name aws-credential --provider aws --aws-access-key $AWS_ACCESS_KEY --aws-secret-key $AWS_SECRET_KEY
px pxb create backuplocation --name s3 --provider s3 --path $BACKUP_BUCKET --cloud-credential-name aws-credential --s3-endpoint s3.amazonaws.com --s3-region $aws_region
px pxb create schedulepolicy --name 15min-schedule --interval-minutes 15 --interval-retain 12

px pxb connect cluster --name cluster-1 --kubeconfig /root/.kube/config

for i in $(seq 2 $clusters); do
  ssh master-$i cat /root/.kube/config > /tmp/cluster-$i-kube-config
  px pxb connect cluster --name cluster-$i --kubeconfig /tmp/cluster-$i-kube-config
done

if [ "$platform" != ocp4 ]; then
  # Patches Prometheus operator to allow multiple instances to run
  kubectl patch deployment prometheus-operator -n kube-system  --type=json -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "-namespaces=kube-system" }]'

ssh master-2 <<EOF
kubectl patch deployment prometheus-operator -n kube-system  --type=json -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "-namespaces=kube-system" }]'
EOF

ssh master-3 << EOF
kubectl patch deployment prometheus-operator -n kube-system  --type=json -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "-namespaces=kube-system" }]'
EOF

fi

cat <<EOF >> /etc/motd
+================================================+
SAVE THE FOLLOWING DETAILS FOR FUTURE REFERENCES
+================================================+
PX-Central User Interface Access URL : http://$PXB_URL
PX-Central admin user name: admin
PX-Central admin user password: $ADMIN_PW
+================================================+
EOF

